<div class="page">
  <!-- Toolbar -->
  <div class="toolbar">
    <mat-form-field appearance="outline" class="search-box">
      <mat-label>Search questions</mat-label>
      <input matInput [formControl]="search" placeholder="Type to search..." />
      <button mat-icon-button matSuffix (click)="onSearchClick()">
        <mat-icon>search</mat-icon>
      </button>
    </mat-form-field>

    <button mat-flat-button class="ask-btn" routerLink="/questions/ask">
      <mat-icon>add_circle</mat-icon>
      Ask Question
    </button>
  </div>

  <!-- Question list -->
  <ng-container *ngIf="questions.length > 0; else noData">
    <div class="q-list">
      <mat-card *ngFor="let q of questions" class="q-card">
        <mat-card-content>
          <div class="row">
            <!-- Thumbnail (uses question-only thumb; fetches detail lazily once) -->
            <ng-container *ngIf="thumbUrl(q) as thumb">
              <div class="thumb-wrap" *ngIf="thumb; else noImg">
                <img
                  class="thumb"
                  [src]="thumb"
                  alt="question image"
                  (click)="openViewer(thumb)"
                />
              </div>
            </ng-container>
            <ng-template #noImg>
              <div class="thumb placeholder">
                <mat-icon>image_not_supported</mat-icon>
              </div>
            </ng-template>

            <!-- Meta -->
            <div class="meta">
              <mat-card-title class="title">{{ q.title }}</mat-card-title>
              <p class="snippet">
                {{ q.text | slice:0:160 }}{{ q.text?.length > 160 ? '…' : '' }}
              </p>
              <small class="info">
                <mat-icon>person</mat-icon> {{ q.author || 'Anonymous' }}
                <span class="dot">•</span>
                <mat-icon>schedule</mat-icon> {{ q.createdAt | date:'mediumDate' }}
              </small>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <button mat-button class="view-btn" [routerLink]="['/questions', q.id]">
            <mat-icon>visibility</mat-icon> View
          </button>
          <button *ngIf="isAdmin" mat-button class="delete-btn" (click)="onDelete(q.id, q.title)">
            <mat-icon>delete</mat-icon> Delete
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <mat-paginator
      [length]="total"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 20]"
      (page)="onPage($event)">
    </mat-paginator>
  </ng-container>

  <!-- Empty state -->
  <ng-template #noData>
    <div class="empty-state">
      <mat-icon>help_outline</mat-icon>
      <p>No questions found. Be the first to ask!</p>
      <button mat-stroked-button class="ask-btn" routerLink="/questions/ask">
        Ask a Question
      </button>
    </div>
  </ng-template>
</div>

<!--aichat-->
<button mat-stroked-button class="ai-btn" (click)="openAiDialog()">
  <mat-icon>smart_toy</mat-icon>
  Ask from AI
</button>




<!-- Image Viewer (Lightbox) -->
<div class="img-viewer" *ngIf="viewerUrl" (click)="closeViewer()">
  <img [src]="viewerUrl" alt="full view" (click)="$event.stopPropagation()" />
  <button class="viewer-close" type="button" (click)="closeViewer()" aria-label="Close">
    &times;
  </button>
</div>